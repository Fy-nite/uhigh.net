using System.Text.Json;
using System.Xml;
using System.Xml.Serialization;
using Wake.Net.Diagnostics;

namespace Wake.Net
{
    public class ProjectFile
    {
        private static readonly JsonSerializerOptions JsonOptions = new()
        {
            WriteIndented = true,
            PropertyNamingPolicy = JsonNamingPolicy.CamelCase
        };

        private static readonly XmlSerializer Serializer = new(typeof(WakeProject));

        public static async Task<WakeProject?> LoadAsync(string projectPath, DiagnosticsReporter? diagnostics = null)
        {
            try
            {
                if (!File.Exists(projectPath))
                {
                    diagnostics?.ReportError($"Project file not found: {projectPath}");
                    return null;
                }

                using var stream = new FileStream(projectPath, FileMode.Open, FileAccess.Read);
                var project = (WakeProject?)Serializer.Deserialize(stream);
                
                if (project == null)
                {
                    diagnostics?.ReportError($"Failed to parse project file: {projectPath}");
                    return null;
                }

                // Resolve relative paths
                var projectDir = Path.GetDirectoryName(projectPath) ?? "";
                for (int i = 0; i < project.SourceFiles.Count; i++)
                {
                    if (!Path.IsPathRooted(project.SourceFiles[i]))
                    {
                        project.SourceFiles[i] = Path.Combine(projectDir, project.SourceFiles[i]);
                    }
                }

                diagnostics?.ReportInfo($"Loaded project: {project.Name} v{project.Version}");
                return project;
            }
            catch (Exception ex)
            {
                diagnostics?.ReportError($"Failed to load project file {projectPath}: {ex.Message}");
                return null;
            }
        }

        public static async Task<bool> SaveAsync(WakeProject project, string projectPath, DiagnosticsReporter? diagnostics = null)
        {
            try
            {
                var settings = new XmlWriterSettings
                {
                    Indent = true,
                    IndentChars = "  ",
                    NewLineChars = "\n",
                    Async = true
                };

                using var writer = XmlWriter.Create(projectPath, settings);
                Serializer.Serialize(writer, project);
                await writer.FlushAsync();
                
                diagnostics?.ReportInfo($"Saved project file: {projectPath}");
                return true;
            }
            catch (Exception ex)
            {
                diagnostics?.ReportError($"Failed to save project file {projectPath}: {ex.Message}");
                return false;
            }
        }

        public static async Task<bool> CreateAsync(string projectName, string projectDir, DiagnosticsReporter? diagnostics = null)
        {
            try
            {
                var project = WakeProject.CreateDefault(projectName);
                var projectPath = Path.Combine(projectDir, $"{projectName}.wakeproj");

                // Create directory if it doesn't exist
                if (!Directory.Exists(projectDir))
                {
                    Directory.CreateDirectory(projectDir);
                }

                // Create a default main.wake file
                var mainWakePath = Path.Combine(projectDir, "main.wake");
                if (!File.Exists(mainWakePath))
                {
                    var defaultCode = $@"// {projectName} - Generated by Wake.Net
// Entry point for your Wake.Net application

func main() {{
    print(""Hello from {projectName}!"")
}}
";
                    await File.WriteAllTextAsync(mainWakePath, defaultCode);
                }

                return await SaveAsync(project, projectPath, diagnostics);
            }
            catch (Exception ex)
            {
                diagnostics?.ReportError($"Failed to create project: {ex.Message}");
                return false;
            }
        }
    }
}
